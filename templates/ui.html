<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refocus - VUE</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.4.8/dist/vuetify.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@5.8.55/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css">
    <script src="https://unpkg.com/vue@3.4.8/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.4.8/dist/vuetify.min.js"></script>
    <script type="text/javascript" src="/public/js/js.cookie.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/intro.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.css">
    <script type="text/javascript" src="/public/js/analytics/consent.js?version={{ js_version }}"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6SKEYMGQ07"></script>
    <script type="text/javascript" src="/public/js/analytics/init.js?version={{ js_version }}"></script>
    <script>
      configGtag("{{base64_encoded_user_id}}", {user_tier: "{{user_tier}}"});
    </script>
    <script type="text/javascript" src="/public/js/analytics/events.js?version={{ js_version }}"></script>
    <style>
      .hero-image {
        width: 100%;
        height: auto;
        max-height: 512px;
      }

      .generated-image {
        cursor: pointer;
      }

      .preview-image {
        min-width: 500px;
      }

      .describe-image-button .v-btn__content {
        white-space: normal;
      }

      .green-shadow {
        text-shadow: 0px 4px 15px rgba(124, 179, 66, 0.8);
      }

      .image-preview {
        background: #2a2a2a;
      }

      .FIE_topbar-save-button {
        display: none !important;
      }

      .FIE_root {
        background: #333 !important;
      }

      .FIE_tabs-drawer {
        background: #333 !important;
      }

      .FIE_tab[aria-selected="false"] {
        background: #525252 !important;
      }

      .FIE_tab-label {
        color: rgb(140 140 140) !important;
      }

      .iIeCpq {
        color: rgb(140 140 140) !important;
      }

      .FIE_topbar-zoom-label {
        color: rgb(140 140 140) !important;
      }

      .FIE_canvas-node {
        background: rgb(100 100 100) !important;
      }

      .FIE_tabs {
        box-shadow: rgb(84 87 90 / 14%) 6px 8px 12px 0px !important;
      }

      .FIE_carousel-next-button {
        background: linear-gradient(270deg, rgb(100 100 100) 1.56%, rgb(100 100 100 / 89%) 52.4%, rgb(100 100 100 / 53%) 76.04%, rgb(100 100 100 / 0%) 100%) !important;
      }

      .FIE_carousel-prev-button {
        background: linear-gradient(90deg, rgb(100, 100, 100) 1.56%, rgba(100, 100, 100, 0.89) 52.4%, rgba(100, 100, 100, 0.533) 76.04%, rgba(100, 100, 100, 0) 100%) !important;
    </style>
  </head>
  <body>
    <div id="app">
      <v-dialog v-model="popup.isOpen" width="50%">
        <v-card border="1000">
          <v-card-title class="text-h5"> Upgrade Now </v-card-title>
            <v-card-text class="text-body-1" v-html="popup.message"></v-card-text>
            <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="grey-darken-1" variant="text" @click="popup.isOpen = false">
              Cancel
            </v-btn>
            <v-btn color="green-darken-1" variant="text" @click="openSubscriptionPage">
              Upgrade
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>
      <v-container>
        <v-row class="d-flex flex-row align-end pa-3">
          <v-alert
            type="info"
            text="Refocus is now in beta version, and all credits consumption are discounted at 25% off!"
            variant="tonal"
            closable
          ></v-alert>
        </v-row>
        <v-row>
          <v-col cols="11">
            <v-row class="d-flex flex-row align-end pa-3">
              <div class="d-flex text-h1 font-weight-bold">imagine</div>
              <div class="d-flex text-subtitle-1 text-grey-lighten-1 ml-1">Powered by Fooocus & Diffus</div>
            </v-row>
          </v-col>
          <v-col cols="1">
            <v-btn
              id="introjs-button"
              icon="mdi-help-circle-outline"
              variant="plain"
              @click="startIntroJS(true)"
            ></v-btn>
          </v-col>
        </v-row>
        <v-row class="d-flex pa-3">
          <v-expansion-panels v-model="panelName" v-show="showImageOptions">
            <v-expansion-panel value="image_options">
              <v-expansion-panel-text eager>
                <v-row
                  class="pa-4"
                  @mouseover="imageOptionsCloseButtonHover = true"
                  @mouseleave="imageOptionsCloseButtonHover = false"
                  @click="toggleImageOptions"
                  style="cursor: pointer"
                >
                  <v-spacer></v-spacer>
                  <v-icon :color="imageOptionsCloseButtonHover ? 'white' : 'grey'" icon="mdi-close"></v-icon>
                </v-row>
                <v-tabs vertical v-model="imageOptionTab">
                  <v-tab value="uov">Upscale or Variation</v-tab>
                  <v-tab value="ip">Image Prompt</v-tab>
                  <v-tab value="inpaint">Inpaint or Outpaint</v-tab>
                  <v-tab value="desc" v-if="false">Describe</v-tab>
                </v-tabs>
                <v-window v-model="imageOptionTab">
                  <v-window-item value="uov" eager>
                    <v-row>
                      <v-col
                        xl="6"
                        lg="6"
                        md="8"
                        sm="12"
                        cols="12"
                      >
                        <v-card variant="flat">
                          <v-card-text>
                            <v-file-input
                              :rules="imageRules"
                              accept="image/*"
                              placeholder="Choose an image file"
                              prepend-icon="mdi-camera"
                              label="Upload Image File"
                              clearable
                              @change="event => previewUserImage(event, 'uovImageFile')"
                              @click:clear="clearPreview('uovImageFile')"
                            ></v-file-input>
                            <v-img
                              v-show="uovImageFile"
                              :src="uovImageFile"
                              class="mt-3 image-preview"
                              max-height="500"
                              contain
                            ></v-img>
                          </v-card-text>
                        </v-card>
                      </v-col>
                      <v-col
                        xl="6"
                        lg="6"
                        md="4"
                        sm="12"
                        cols="12"
                      >
                        <div class="d-flex justify-start">
                          <v-radio-group v-model="uovSelection" label="Upscale or Variation">
                            <v-radio
                              v-for="(name, index) in uovMethods"
                              :label="name"
                              :value="name">
                            </v-radio>
                          </v-radio-group>
                        </div>
                      </v-col>
                    </v-row>
                  </v-window-item>
                  <v-window-item value="ip" eager>
                    <v-row>
                      <v-col
                        v-for="index in numImagePrompts"
                        :key="index"
                        xl="3"
                        lg="6"
                        md="6"
                        sm="12"
                        cols="12"
                      >
                        <v-card
                          variant="elevated"
                        >
                          <v-card-text class="pa-0">
                            <v-file-input
                              :rules="imageRules"
                              accept="image/*"
                              placeholder="Choose an image file"
                              prepend-icon="mdi-camera"
                              label="Image File"
                              clearable
                              @change="event => previewUserImage(event, 'imagePromptImages', index - 1)"
                              @click:clear="clearPreview('imagePromptImages', index - 1)"
                            ></v-file-input>
                            <v-img
                              :src="imagePromptImages[index - 1]? imagePromptImages[index - 1]: 'https://diffus-public-static-assets.s3.amazonaws.com/static/placeholder-image.png'"
                              class="mt-3 image-preview"
                              :id="`image_prompts_container_${index - 1}`"
                              :cover="imagePromptImages[index - 1]? false: true"
                              height="480"
                            ></v-img>
                            <v-expansion-panels v-model="imagePromptAdvancedPanel">
                              <v-expansion-panel value="advanced">
                                <v-expansion-panel-title>Advanced Options</v-expansion-panel-title>
                                <v-expansion-panel-text>
                                  <v-row>
                                    <v-col>
                                      <v-slider
                                        v-model="imagePrompts[index-1].params.stopAt"
                                        :min="0"
                                        :max="1"
                                        :step="0.001"
                                        label="Stop at"
                                      >
                                        <template v-slot:append>
                                          <v-text-field
                                            v-model="imagePrompts[index-1].params.stopAt"
                                            hide-details
                                            single-line
                                            density="compact"
                                            type="number"
                                            style="width: 70px"
                                          ></v-text-field>
                                        </template>
                                      </v-slider>
                                    </v-col>
                                    <v-col>
                                      <v-slider
                                        v-model="imagePrompts[index-1].params.weight"
                                        :min="0"
                                        :max="2"
                                        :step="0.001"
                                        label="Weight"
                                      >
                                        <template v-slot:append>
                                          <v-text-field
                                            v-model="imagePrompts[index-1].params.weight"
                                            hide-details
                                            single-line
                                            density="compact"
                                            type="number"
                                            style="width: 70px"
                                          ></v-text-field>
                                        </template>
                                      </v-slider>
                                    </v-col>
                                  </v-row>
                                  <v-row>
                                    <v-radio-group
                                      v-model="imagePrompts[index-1].params.controlType"
                                      inline
                                      @update:model-value="updateImagePromptDefault(index-1, imagePrompts[index-1].params.controlType)"
                                    >
                                      <v-radio
                                        v-for="(name, index) in ipTypes"
                                        :label="name"
                                        :value="name"
                                      >
                                      </v-radio>
                                    </v-radio-group>
                                  </v-row>
                                </v-expansion-panel-text>
                              </v-expansion-panel>
                            </v-expansion-panels>
                          </v-card-text>
                        </v-card>
                      </v-col>
                    </v-row>
                  </v-window-item>
                  <v-window-item value="inpaint" eager>
                    <v-row>
                      <v-col cols="12">
                        <v-card variant="flat">
                          <v-card-text>
                            <v-file-input
                              v-model="inpaintImageFiles"
                              :rules="imageRules"
                              accept="image/*"
                              placeholder="Choose an image file"
                              prepend-icon="mdi-camera"
                              label="Upload an Image File"
                              clearable
                              @change="editUserImage"
                              @click:clear="clearEdit()"
                            ></v-file-input>
                            <div v-show="inpaintImageUploader !== null" id="inpaint-image-editor" style="height: 80vh; width: 100%;"></div>
                          </v-card-text>
                        </v-card>
                      </v-col>
                    </v-row>
                    <v-tabs vertical v-model="inpaintSelection">
                      <v-tab value="Inpaint or Outpaint (default)">Inpaint or Outpaint (default)</v-tab>
                      <v-tab value="Improve Detail (face, hand, eyes, etc.)">Improve Detail (face, hand, eyes, etc.)</v-tab>
                      <v-tab value="Modify Content (add objects, change background, etc.)">Modify Content (add objects, change background, etc.)</v-tab>
                    </v-tabs>
                    <v-window v-model="inpaintSelection">
                      <v-window-item value="Inpaint or Outpaint (default)">
                        <div class="ma-4">
                          <v-combobox
                            v-model="outpaintDirection"
                            :items="['Left', 'Right', 'Top', 'Bottom']"
                            label="Outpaint Direction"
                            multiple
                            chips
                            small-chips
                          ></v-combobox>
                         </div>
                      </v-window-item>
                      <v-window-item value="Improve Detail (face, hand, eyes, etc.)">
                        <div class="ma-4">
                          <v-text-field
                            v-model="inpaintImprovementPrompt"
                            label="Inpaint Additional Prompt"
                            clearable
                            rows="1"
                            variant="solo-filled"
                            auto-grow
                            placeholder="Describing what you want to see at the masks for enhencement."
                          ></v-text-field>
                          <span>Prompts Quick List</span>
                          <v-chip-group v-model="inpaintImprovementPrompt">
                            <v-chip value="highly detailed face">highly detailed face</v-chip>
                            <v-chip value="detailed girl face">detailed girl face</v-chip>
                            <v-chip value="detailed man face">detailed man face</v-chip>
                            <v-chip value="detailed hand">detailed hand</v-chip>
                            <v-chip value="beautiful eyes">beautiful eyes</v-chip>
                          </v-chip-group>
                        </div>
                      </v-window-item>
                      <v-window-item value="Modify Content (add objects, change background, etc.)">
                        <div class="ma-4">
                          <v-text-field
                            v-model="inpaintModificationPrompt"
                            label="Inpaint Additional Prompt"
                            clearable
                            rows="1"
                            variant="solo-filled"
                            auto-grow
                            placeholder="Describing what you want to see at the masks for modification."
                          ></v-text-field>
                        </div>
                      </v-window-item>
                    </v-window>
                  </v-window-item>
                  <v-window-item value="desc" eager>
                    <v-row>
                      <v-col
                        xxl="6"
                        xl="6"
                        lg="6"
                        md="8"
                        sm="12"
                        cols="12"
                      >
                        <v-card variant="flat">
                          <v-card-text>
                            <v-file-input
                              :rules="imageRules"
                              accept="image/*"
                              placeholder="Choose an image file"
                              prepend-icon="mdi-camera"
                              label="Image File"
                              clearable
                              @change="event => previewUserImage(event, 'describeImageUploader')"
                              @click:clear="clearPreview('describeImageUploader')"
                            ></v-file-input>
                            <v-img
                              v-show="describeImageUploader"
                              :src="describeImageUploader"
                              class="mt-3 image-preview"
                              max-height="500"
                              contain
                            ></v-img>
                          </v-card-text>
                        </v-card>
                      </v-col>
                      <v-col
                        xxl="6"
                        xl="6"
                        lg="6"
                        md="4"
                        sm="12"
                        cols="12"
                      >
                        <div class="ma-2">
                          <v-radio-group v-model="contentTypeSelection" label="Content Type" inline>
                            <v-radio
                              v-for="(name, index) in contentTypes"
                              :label="name"
                              :value="name">
                            </v-radio>
                          </v-radio-group>
                        </div>
                        <div class="ma-4">
                          <v-btn
                            class="describe-image-button"
                            block
                            color="grey-lighten-1"
                            height="48"
                            :loading="describeImageLoading"
                            @click="describeImageLocal"
                          >
                            <span style="white-space: normal;">
                              Describe into Prompt (BLIP)<br/>
                              <span class="text-caption" v-html="getConsumeText(this.estimateBlipConsume)">
                              </span>
                            </span>
                          </v-btn>
                        </div>
                        <div class="ma-4" v-if="false">
                          <v-btn
                            class="describe-image-button"
                            block
                            color="#5a3cff"
                            height="48"
                          >Describe into Prompt (GPT-4)</v-btn>
                        </div>
                      </v-col>
                    </v-row>
                  </v-window-item>
                </v-window>
              </v-expansion-panel-text>
            </v-expansion-panel>
          </v-expansion-panels>
        </v-row>

        <v-row>
          <v-col
            xxl="9"
            xl="9"
            lg="9"
            md="9"
            sm="12"
            cols="12"
          >
            <v-textarea
              v-model="prompt"
              id="prompt-textarea"
              clearable
              variant="solo-filled"
              rows="1"
              auto-grow
              placeholder="Describe what you want to see..."
              min-height="56px"
            >
              <template v-slot:append-inner>
                <v-btn
                  id="img2img-button"
                  :color="showImageOptions? 'light-green-lighten-5': 'grey-lighten-4'"
                  variant="text"
                  @click="toggleImageOptions"
                >
                  <span
                    :class="{'material-icons': true, 'green-shadow': showImageOptions}"
                  >add_photo_alternate</span>
                </v-btn>
              </template>
            </v-textarea>
          </v-col>
          <v-col
            xxl="3"
            xl="3"
            lg="3"
            md="3"
            sm="12"
            cols="12"
          >
            <v-btn
              v-if="!generating"
              id="generate-button"
              @click="startToGenerate(0)"
              width="100%"
              height="56px"
              color="#5a3cff"
              :disabled="loadingPreset"
            >
              <span style="white-space: normal;">
                Generate<br/>
                <span class="text-caption" v-html="getConsumeText(this.estimateConsume, this.estimateConsume.imageNumber)">
                </span>
              </span>
            </v-btn>
            <v-row v-if="generating" class="d-flex pa-0 ma-0" width="100%">
            <v-col class="d-flex pa-0 mr-1">
              <v-btn @click="skipGeneration" :loading="skipLoading" width="100%" height="56px" color="grey-lighten-1">Skip</v-btn>
            </v-col>
            <v-col class="d-flex pa-0 ml-1">
              <v-btn @click="stopGeneration" :loading="stopLoading" width="100%" height="56px" color="red-lighten-1">Stop</v-btn>
            </v-col>
            </v-row>
          </v-col>
        </v-row>

        <div class="mb-4 mb-md-0 mb-lg-0i mb-sm-0 mb-xl-0 mb-xxl-0" width="100%"></div>

        <!-- Options Section -->
        <v-expansion-panels>
          <v-expansion-panel>
            <v-expansion-panel-title
              expand-icon="mdi-tune"
              collapse-icon="mdi-tune"
            >Options<v-chip
                v-show="!selectingPreset && !loadingPreset"
                id="preset-clip"
                class="ma-2"
                :color="presetColor[selectedPreset]"
                @click.stop="selectingPreset = true"
              >
                [[ presetName[selectedPreset] ]]
              </v-chip>
              <div
                v-show="selectingPreset && !loadingPreset"
              >
                <v-chip
                  v-for="preset in availablePresets"
                  class="ma-2"
                  :key="preset"
                  :color="presetColor[preset]"
                  @click.stop="updateDefaultOptions(preset)"
                >
                  [[ presetName[preset] ]]
                </v-chip>
              </div>
              <v-progress-circular
                v-show="loadingPreset"
                class="ma-2"
                indeterminate
                color="#5a3cff"
              ></v-progress-circular>
            </v-expansion-panel-title>
            <v-expansion-panel-text>
              <v-tabs vertical v-model="settingTab">
                <v-tab value="settings">Settings</v-tab>
                <v-tab value="styles">Styles</v-tab>
                <v-tab value="models">Models</v-tab>
                <v-tab value="advanced">Advanced</v-tab>
              </v-tabs>
              <v-window v-model="settingTab">
                <v-window-item value="settings">
                  <!-- Performance Options -->
                  <v-radio-group inline v-model="performance" label="Performance">
                    <v-radio v-for="item in performanceOptions" :label="item" :value="item"></v-radio>
                  </v-radio-group>
                  <!-- Aspect Ratios -->
                  <v-select
                    v-model="aspectRatio"
                    label="Aspect Ratios (width × height)"
                    :items="aspectRatios"
                  ></v-select>
                  <!-- Image Number Slider -->
                  <v-slider
                    v-model="imageNumber"
                    :min="1"
                    :max="32"
                    :step="1"
                    label="Number of Images to Generate"
                  >
                    <template v-slot:append>
                      <v-text-field
                        v-model="imageNumber"
                        hide-details
                        single-line
                        density="compact"
                        type="number"
                        style="width: 70px"
                      ></v-text-field>
                    </template>
                  </v-slider>
                  <!-- Negative Prompt -->
                  <v-text-field
                    v-model="negativePrompt"
                    label="Negative Prompt"
                    clearable
                    rows="1"
                    variant="solo-filled"
                    auto-grow
                    placeholder="Describing what you do not want to see."
                  ></v-text-field>
                  <!-- Random Checkbox -->
                  <v-checkbox
                    v-model="isRandom"
                    label="Use Random Seed"
                    @change="toggleRandom"
                  ></v-checkbox>
                  <!-- Random Seed -->
                  <v-text-field
                    v-model="randomSeed"
                    label="Random Seed"
                    :disabled="isRandom"
                    type="number"
                  ></v-text-field>
                </v-window-item>
                <v-window-item  value="styles">
                  <!-- Styles Search Bar -->
                  <v-combobox
                    v-model="selectedStyles"
                    :items="styles"
                    item-title="name"
                    item-value="name"
                    :return-object="false"
                    label="Select specific style(s)"
                    multiple
                    chips
                    closable-chips
                    small-chips
                  >
                    <template v-slot:item="{ props, item }">
                      <v-list-item v-bind="props">
                        <template v-slot:prepend>
                          <v-avatar @mouseover="mouseMoveToStylePreview(item.raw.image)">
                            <v-img :src="item.raw.image"></v-img>
                          </v-avatar>
                        </template>
                      </v-list-item>
                    </template>
                  </v-combobox>
                  <v-overlay
                    v-model="styleOverlay.show"
                    class="align-center justify-center"
                    min-height="300"
                    min-width="300"
                    @mousemove="styleOverlay.show = false"
                  >
                    <v-img :src="styleOverlay.src"></v-img>
                  </v-overlay>                </v-window-item>
                <v-window-item  value="models">
                  <v-row>
                    <v-col
                      cols="12"
                    >
                      <v-select
                        v-model="baseModel"
                        label="Base Model (SDXL only)"
                        :items="baseModels"
                      ></v-select>
                    </v-col>
                  </v-row>
                  <v-row>
                    <v-col
                      xxl="6"
                      xl="6"
                      lg="6"
                      md="6"
                      sm="12"
                      cols="12"
                    >
                      <v-select
                        v-model="refiner"
                        label="Refiner (SDXL)"
                        :items="refiners"
                        :disabled="isLCMMode"
                      ></v-select>
                    </v-col>
                    <v-col
                      xxl="6"
                      xl="6"
                      lg="6"
                      md="6"
                      sm="12"
                      cols="12"
                    >
                      <v-slider
                        v-model="refinerSwitch"
                        :min="0"
                        :max="1.0"
                        :step="0.0001"
                        label="Refiner Switch At"
                        :disabled="refiner === 'None'"
                      >
                        <template v-slot:append>
                          <v-text-field
                            v-model="refinerSwitch"
                            hide-details
                            single-line
                            density="compact"
                            type="number"
                            style="width: 70px"
                          ></v-text-field>
                        </template>
                      </v-slider>
                    </v-col>
                  </v-row>
                  <v-row v-for="n in numLoras" :key="n-1">
                    <v-col
                      xxl="6"
                      xl="6"
                      lg="6"
                      md="6"
                      sm="12"
                      cols="12"
                    >
                      <v-select
                        v-model="selectedLoraModels[n-1]"
                        :label="`LoRA ${n}`"
                        :items="loraModels"
                      ></v-select>
                    </v-col>
                    <v-col
                      xxl="6"
                      xl="6"
                      lg="6"
                      md="6"
                      sm="12"
                      cols="12"
                    >
                      <v-slider
                        v-model="selectedLoraWeights[n-1]"
                        :min="-2"
                        :max="2"
                        :step="0.01"
                        :label="`LoRA ${n} Weight`"
                      >
                        <template v-slot:append>
                          <v-text-field
                            v-model="selectedLoraWeights[n-1]"
                            hide-details
                            single-line
                            density="compact"
                            type="number"
                            style="width: 70px"
                          ></v-text-field>
                        </template>
                      </v-slider>
                    </v-col>
                  </v-row>
                </v-window-item>
                <v-window-item  value="advanced">
                  <v-slider
                    v-model="guidanceScale"
                    :min="1"
                    :max="30"
                    :step="0.01"
                    :disabled="isLCMMode"
                    label="Guidance Scale"
                  >
                    <template v-slot:append>
                      <v-text-field
                        v-model="guidanceScale"
                        hide-details
                        single-line
                        density="compact"
                        type="number"
                        style="width: 70px"
                      ></v-text-field>
                    </template>
                  </v-slider>
                  <v-slider
                    v-model="imageSharpness"
                    :min="0"
                    :max="30"
                    :step="0.01"
                    :disabled="isLCMMode"
                    label="Image Sharpness"
                  >
                    <template v-slot:append>
                      <v-text-field
                        v-model="imageSharpness"
                        hide-details
                        single-line
                        density="compact"
                        type="number"
                        style="width: 70px"
                      ></v-text-field>
                    </template>
                  </v-slider>
                  <v-select
                    v-model="selectedSampler"
                    label="Sampler"
                    :items="availableSamplers"
                    :disabled="isLCMMode"
                  ></v-select>
                  <v-select
                    v-model="selectedScheduler"
                    label="Scheduler"
                    :items="availableSchedulers"
                    :disabled="isLCMMode"
                  ></v-select>
                  <v-slider
                    v-model="forcedSteps"
                    v-if="forcedSteps >= 1"
                    :min="0"
                    :max="200"
                    :step="1"
                    :disabled="true"
                    label="Sampling Steps"
                  >
                    <template v-slot:append>
                      <v-text-field
                        v-model="forcedSteps"
                        hide-details
                        single-line
                        density="compact"
                        type="number"
                        style="width: 70px"
                      ></v-text-field>
                    </template>
                  </v-slider>
                </v-window-item>
              </v-window>
            </v-expansion-panel-text>
          </v-expansion-panel>
        </v-expansion-panels>

        <!-- Preview Section -->
        <v-card
            v-if="generating"
          :loading="generating"
          class="mx-auto my-12"
        >
          <template v-slot:loader="{ isActive }">
            <v-progress-linear
              v-model="runningTaskProgress"
              :active="isActive"
              color="#5a3cff"
              height="4"
              :indeterminate="waiting"
            ></v-progress-linear>
          </template>
          <v-row>
            <v-col v-if="generating" class="preview-image" cols="4">
              <v-img :src="runningTaskPreviewImage" class="hero-image"></v-img>
            </v-col>
            <v-col cols="auto">
              <v-card-item>
                <v-card-title>[[ runningTaskMessage ]]</v-card-title>
                <v-card-subtitle v-if="runningTaskId">Task id: [[ runningTaskId ]]</v-card-subtitle>
              </v-card-item>
              <v-card-text class="pa-0">
                <v-slide-group
                  show-arrows
                  class="d-flex flex-row">
                  <v-slide-group-item
                    v-for="(image, index) in runningTaskResultImages"
                    :key="index"
                    v-slot="{ selectedClass }"
                  >
                    <v-img
                      :src="image.src"
                      :class="['generated-image', 'ma-2', 'previewable-image', selectedClass]"
                      max-width="300px"
                      min-width="300px"
                      @click="expandImage(index, runningTaskResultImages)"
                    >
                      <v-container class="fill-height d-flex align-end pa-0">
                        <v-row  align="end" class="ma-0">
                          <v-spacer></v-spacer>
                          <v-btn
                            v-if="false"
                            size="small"
                            :color="likeButtonColor[image.id]? likeButtonColor[image.id]: 'grey-lighten-4'"
                            variant="text"
                            icon="mdi-heart"
                            @click.stop="likeOrUnlike(image.id)"></v-btn>
                          <v-btn
                            v-if="false"
                            size="small"
                            :color="favoriteButtonColor[image.id]? favoriteButtonColor[image.id]: 'grey-lighten-4'"
                            variant="text"
                            icon="mdi-bookmark"
                            @click.stop="favoriteOrUnfavorite(image.id)"></v-btn>
                          <v-btn
                            v-if="false"
                            size="small"
                            :color="shareButtonColor[image.id]? shareButtonColor[image.id]: 'grey-lighten-4'"
                            variant="text"
                            icon="mdi-share-variant"
                            @click.stop="shareOrUnshare(image.id)"></v-btn>
                        </v-row>
                      </v-container>
                    </v-img>
                  </v-slide-group-item>
                </v-slide-group>
              </v-card-text>
            </v-col>
          </v-row>
        </v-card>

        <v-card
          v-for="(result, historyIndex) in historyResults"
          class="mx-auto my-12"
        >
          <v-card-item>
            <v-card-title>Task ID [[ result.taskId ]]</v-card-title>
            <v-card-subtitle>[[ result.params.prompt ]]</v-card-subtitle>
            <v-alert v-if="result.errorMessage" type="error" :text="result.errorMessage"></v-alert>
          </v-card-item>
          <v-card-text class="pa-0">
            <v-slide-group
              show-arrows
              class="d-flex flex-row">
              <v-slide-group-item
                v-for="(image, index) in result.images"
                :key="index"
                v-slot="{ selectedClass }"
              >
                <v-img
                  :src="image.src"
                  :class="['generated-image', 'ma-2', 'previewable-image', selectedClass]"
                  max-width="300px"
                  min-width="300px"
                  @click="expandImage(index, result.images)"
                >
                  <v-container class="fill-height d-flex align-end pa-0">
                    <v-row  align="end" class="ma-0">
                      <v-spacer></v-spacer>
                      <v-btn
                        v-if="false"
                        size="small"
                        :color="likeButtonColor[image.id]? likeButtonColor[image.id]: 'grey-lighten-4'"
                        variant="text"
                        icon="mdi-heart"
                        @click.stop="likeOrUnlike(image.id)"></v-btn>
                      <v-btn
                        v-if="false"
                        size="small"
                        :color="favoriteButtonColor[image.id]? favoriteButtonColor[image.id]: 'grey-lighten-4'"
                        variant="text"
                        icon="mdi-bookmark"
                        @click.stop="favoriteOrUnfavorite(image.id)"></v-btn>
                      <v-btn
                        v-if="false"
                        size="small"
                        :color="shareButtonColor[image.id]? shareButtonColor[image.id]: 'grey-lighten-4'"
                        variant="text"
                        icon="mdi-share-variant"
                        @click.stop="shareOrUnshare(image.id)"></v-btn>
                    </v-row>
                  </v-container>
                </v-img>
              </v-slide-group-item>
            </v-slide-group>
            <v-expansion-panels>
              <v-expansion-panel>
                <v-expansion-panel-title>Generation parameters</v-expansion-panel-title>
                <v-expansion-panel-text>
                  <v-table density="compact">
                    <template v-slot:default>
                      <tbody>
                        <tr
                          v-for="(item, i) in result.paramsTable"
                          :key="item.name"
                        >
                          <td><b>[[ item.name ]]</b></td>
                          <td>[[ item.value ]]</td>
                        </tr>
                        <tr v-if="result.params.uov_input_image"
                        >
                          <td><b>upscale & variation input</b></td>
                          <td>
                            <v-img
                              :src="result.params.uov_input_image.encoded_image"
                              max-width="300px"
                              min-width="300px"
                              @click="expandImage(0, [{src: result.params.uov_input_image.encoded_image}])"
                            >
                          </td>
                        </tr>
                        <tr v-if="result.params.ip_ctrls"
                        >
                          <td><b>image prompts</b></td>
                          <td>
                            <v-slide-group
                              show-arrows
                              class="d-flex flex-row">
                              <v-slide-group-item
                                v-for="(ip_control, index) in result.params.ip_ctrls"
                                :key="index"
                                v-slot="{ selectedClass }"
                              >
                                <v-img
                                  :src="ip_control.ip_image.encoded_image"
                                  :class="['generated-image', 'ma-2', 'previewable-image', selectedClass]"
                                  max-width="300px"
                                  min-width="300px"
                                  @click="expandImage(index, result.params.ip_ctrls.map(item => {return {src: item.ip_image.encoded_image};}))"
                                >
                                </v-img>
                              </v-slide-group-item>
                            </v-slide-group>
                          </td>
                        </tr>
                        <tr v-if="result.params.inpaint_input_image"
                        >
                          <td><b>inpaint inputs</b></td>
                          <td>
                            <v-slide-group
                              show-arrows
                              class="d-flex flex-row">
                              <v-slide-group-item
                                v-slot="{ selectedClass }"
                              >
                                <v-img
                                  :src="result.params.inpaint_input_image.image.encoded_image"
                                  :class="['generated-image', 'ma-2', 'previewable-image', selectedClass]"
                                  max-width="300px"
                                  min-width="300px"
                                  @click="expandImage(0, [{src: result.params.inpaint_input_image.image.encoded_image}, {src: result.params.inpaint_input_image.mask.encoded_image}])"
                                >
                                </v-img>
                              </v-slide-group-item>
                              <v-slide-group-item
                                v-slot="{ selectedClass }"
                              >
                                <v-img
                                  :src="result.params.inpaint_input_image.mask.encoded_image"
                                  :class="['generated-image', 'ma-2', 'previewable-image', selectedClass]"
                                  max-width="300px"
                                  min-width="300px"
                                  @click="expandImage(1, [{src: result.params.inpaint_input_image.image.encoded_image}, {src: result.params.inpaint_input_image.mask.encoded_image}])"
                                >
                                </v-img>
                              </v-slide-group-item>
                            </v-slide-group>
                          </td>
                        </tr>
                      </tbody>
                    </template>
                  </v-table>
                </v-expansion-panel-text>
              </v-expansion-panel>
            </v-expansion-panels>
          </v-card-text>
        </v-card>

        <v-dialog
          v-model="previewDialog"
          width="75%"
        >
          <v-carousel
            v-model="previewIndex"
            hide-delimiter-background
          >
            <v-carousel-item
              v-for="(image, i) in previewImages"
              :src="image.src"
              :key="i"
              :value="i"
            >
            </v-carousel-item>
          </v-carousel>
        </v-dialog>
      </v-container>
    </div>

    <script src="https://scaleflex.cloudimg.io/v7/plugins/filerobot-image-editor/latest/filerobot-image-editor.min.js"></script>
    <script type="text/javascript" src="/api/focus/static/js/mask.js"></script>
    <script type="text/javascript" src="/api/focus/static/js/utils.js"></script>
    <script>
      const AFFILIATE_PROGRAM = '<a href="/affiliate/everyone" target="_blank" style="text-wrap: nowrap">Affiliate Program</a>';
    </script>
    <script type="module" src="/public/js/analytics/cookieconsent-config.mjs?version={{ js_version }}"></script>
    <script>
      const { createApp } = Vue;
      const { createVuetify } = Vuetify;

      const defaultTheme = {
        dark: true,
        colors: {
          background: '#0b0f19',
          primary: '#5a3cff',
        },
      }

      const vuetify = createVuetify({
        theme: {
          defaultTheme: 'defaultTheme',
          themes: {
            defaultTheme,
          },
        },
      });

      createApp({
        delimiters: ['[[', ']]'],
        data() {
          return {
            hostname: "",
            settingTab: "settings",
            prompt: '',
            _performance: 'Speed',
            performanceOptions: [],
            forcedSteps: null,
            aspectRatio: '1:1',
            aspectRatios: [],
            imageNumber: 2,
            negativePrompt: '',
            isRandom: true,
            randomSeed: 0,
            selectedStyles: [],
            styles: [],
            baseModel: '',
            baseModels: [],
            refiner: '',
            refiners: [],
            refinerSwitch: 0.5,
            loraModels: [],
            numLoras: 0,
            selectedLoraModels: [],
            selectedLoraWeights: [],
            guidanceScale: 4.0,
            imageSharpness: 2.0,
            defaultOptions: {},
            runningTaskId: '',
            runningTaskStatus: '',
            runningTaskProgress: 0,
            runningTaskMessage: '',
            runningTaskReturnUrl: false,
            runningTaskPreviewImage: '',
            runningTaskResultImages: [],
            runningTaskQueueLength: 0,
            runningTaskQueuePosiiton: 0,
            generating: false,
            generatingParams: {},
            waiting: true,
            maxHistory: 10,
            historyResults: [],
            previewDialog: false,
            previewIndex: 0,
            previewImages: [],
            likeButtonColor: {},
            favoriteButtonColor: {},
            shareButtonColor: {},
            skipLoading: false,
            stopLoading: false,
            panelName: 'image_options',
            showImageOptions: false,
            imageOptionTab: 'uov',
            uovSelection: 'Disabled',
            uovMethods: [],
            imagePrompts: [],
            ipTypes: [],
            numImagePrompts: 4,
            imagePromptImages: [],
            imagePromptAdvancedPanel: "",
            imagePromptDefaultValues: {},
            contentTypeSelection: "Photograph",
            contentTypes: [],
            describeImageUploader: null,
            inpaintImageUploader: null,
            inpaintImageFiles: [],
            inpaintSelection: "Inpaint or Outpaint (default)",
            outpaintDirection: [],
            inpaintImprovementPrompt: "",
            inpaintModificationPrompt: "",
            inpaintStep: "Upload Image",
            uovImageFile: "",
            imageRules: [
              value => {
                return !value || !value.length || value[0].size < 10000000 || 'Avatar size should be less than 10 MB!'
              },
            ],
            imageEditor: null,
            imageOptionsCloseButtonHover: false,
            toolObserver: null,
            optionsObserver: null,
            describeImageLoading: false,
            selectedPreset: "",
            availablePresets: [],
            selectingPreset: false,
            loadingPreset: false,
            presetName: {
              "default": "cinematic",
              "sai": "stability ai",
            },
            presetColor: {
              "default": "green",
              "anime": "deep-orange",
              "lcm": "light-green",
              "realistic": "light-blue",
              "sai": "pink",
              "turbo": "amber",
              "lighting": "blue-accent-3",
            },
            selectedSampler: "dpmpp_2m_sde_gpu",
            availableSamplers: [],
            selectedScheduler: "karras",
            availableSchedulers: [],
            styleOverlay: {
              show: false,
              src: "",
            },
            nonLCMArguments: {},
            estimateConsume: {
                args: {},
                timeoutId: null,
                inference: "-",
                discount: 0,
                imageNumber: 2,
            },
            estimateBlipConsume: {
                inference: "-",
                discount: 0,
            },
            popup: {
              isOpen: false,
              itemName: "",
              message: "",
              URL: "/user#/subscription?type=subscription",
            },
            userOrderInformation: null,
          };
        },
        methods: {
          startIntroJS(force = false) {
            const cookie_key = "_fooocus_introjs_showed";
            if (!force && window.Cookies.get(cookie_key)) {
                return;
            }
            const introjs = getIntroJS();
            introjs.onexit(() => window.Cookies.set(cookie_key, true, { expires: 360 }));
            introjs.start();
          },
          checkNSFW(is_nsfw) {
            if (is_nsfw.length === 0 || !is_nsfw[is_nsfw.length - 1]) {
              return;
            }
            this.popup.message =
                `Potential NSFW content was detected in the generated image, \
                 upgrade to enable your private image storage. Or join our ${AFFILIATE_PROGRAM} \
                 to earn cash or credits and use it to upgrade to <b>Basic</b> plan.`;
            this.popup.itemName = "refocus_nsfw_checker";
            this.popup.isOpen = true;
            addPopupGtagEvent(this.popup.URL, this.popup.itemName);
          },
          pushHistory(errorMessage = null) {
            this.historyResults.unshift({
              taskId: this.runningTaskId,
              params: this.generatingParams,
              paramsTable: this.turnObjParams(this.generatingParams),
              images: this.runningTaskResultImages,
              errorMessage: errorMessage,
            });
            if (this.historyResults.length > this.maxHistory) {
              this.historyResults.pop();
            }
          },
          mouseMoveToStylePreview(src) {
            this.styleOverlay.show = true;
            this.styleOverlay.src = src;
          },
          previewUserImage(image, imageSrcProperty, index=null) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                if (index != null)
                  this[imageSrcProperty][index] = e.target.result;
                else
                  this[imageSrcProperty] = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          },
          clearPreview(imageSrcProperty, index=null) {
            if (index != null)
              this[imageSrcProperty][index] = null;
            else
              this[imageSrcProperty] = null;
          },
          editUserImage(event) {
            const targetNode = document.getElementById("inpaint-image-editor");
            const config = {childList: true, subtree: true};
            if (!this.toolObserver) {
              const callback = (mutationList, observer) => {
                const tools = document.querySelectorAll(".FIE_tools-item-wrapper");
                if (tools.length > 0) {
                  tools.forEach(tool => {
                    const toolText = tool.querySelector("div > label > span").textContent;
                    if (toolText === "Image" || toolText === "Polygon" || toolText === "Arrow") {
                      tool.style.display = "none";
                    }
                  });
                }
              };
              this.toolObserver = new MutationObserver(callback);
              this.toolObserver.observe(targetNode, config);
            }
            if (!this.optionsObserver) {
              const optionsCallback = (mutationList, observer) => {
                const options = document.querySelectorAll(".FIE_annotation-option-triggerer");
                const penOptions = document.querySelector(".FIE_pen-tool-options");
                const lineOptions = document.querySelector(".FIE_line-tool-options");
                if (options.length > 0) {
                  options.forEach(option => {
                    if (option.title === "Text alignment" || option.title === "Text spacings" || option.title === "Shadow" || option.title === "Corner Radius") {
                      option.style.display = "none";
                    }
                    if (!penOptions && !lineOptions) {
                      if (option.title === "Stroke") {
                        option.style.display = "none";
                        }
                    }
                  });
                  }
              };
              this.optionsObserver = new MutationObserver(optionsCallback);
              this.optionsObserver.observe(targetNode, config);
            }
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                this.inpaintImageUploader = e.target.result;
                this.ImageEditor.render({
                  source: e.target.result,
                });
              };
              reader.readAsDataURL(file);
            }
          },
          clearEdit() {
            this.inpaintImageUploader = null;
            this.ImageEditor.render();
          },
          initializeFilerobot() {
            const container = document.getElementById("inpaint-image-editor");
            const config = {
              tabsIds: [FilerobotImageEditor.TABS.ANNOTATE, FilerobotImageEditor.TABS.RESIZE],
              defaultTabId: FilerobotImageEditor.TABS.ANNOTATE,
              defaultToolId: FilerobotImageEditor.TOOLS.PEN,
              observePluginContainerSize: true,
              annotationsCommon: {
                fill: '#FFFFFF',
                stroke: '#FFFFFF',
                opacity: 0.6,
              },
              Pen: {
                strokeWidth: 30,
              },
              Text: {
                text: 'Change me!',
                fontSize: 28,
                fontStyle: "bold",
              },
              Line: {
                lineCap: 'butt',
                strokeWidth: 16,
              },
              onBeforeSave: ()=>false,
              onSave: (imageInfo, designState) => {
                return false;
              }
            };
            this.ImageEditor = new window.FilerobotImageEditor(container, config);
          },
          toggleImageOptions() {
            if (this.showImageOptions) {
              this.showImageOptions = false;
            } else {
              this.panelName = 'image_options';
              this.showImageOptions = true;
            }
          },
          turnObjParams(obj) {
            return Object.keys(obj).filter(key => {
              if (key === "uov_input_image") {
                return false;
              } else if (key === "ip_ctrls") {
                return false;
              } else if (key === "inpaint_input_image") {
                return false;
              } else {
                return obj[key];
              }
            })
            .map(key => {
              if (key === 'loras') {
                const lorasHtml = obj[key].filter(
                  lora => lora.lora_model.toLowerCase() !== "none")
                  .map((lora, index) => {
                    return `${lora.lora_model}: ${lora.lora_weight}`;
                  }).join('; ');
                return {name: key, value: lorasHtml};
              } else if (key === 'style_selections') {
                return {name: key, value: obj[key].join(', ')};
              } else if (key === 'advanced_options') {
                  return {name: key, value: Object.keys(obj[key]).map(secondaryKey => {
                    return `${secondaryKey}: ${obj[key][secondaryKey]}`;
                  }).join('\n')};
              } else if (obj[key]) {
                return {name: key, value: obj[key]};
              }
            });
          },
          packGenerationParameters() {
            let genParams = {
              task_id: this.runningTaskId,
              prompt: this.prompt,
              negative_prompt: this.negativePrompt,
              style_selections: this.selectedStyles,
              performance_selection: this.performance,
              aspect_ratios_selection: this.aspectRatio,
              image_number: this.imageNumber,
              image_seed: this.isRandom? -1: this.randomSeed,
              sharpness: this.imageSharpness,
              guidance_scale: this.guidanceScale,
              base_model: this.baseModel,
              refiner_model: this.refiner,
              loras: this.selectedLoraModels.map((model, index) => ({
                lora_model: model,
                lora_weight: this.selectedLoraWeights[index]
              })),
              advanced_options: {
                sampler_name: this.selectedSampler,
                scheduler_name: this.selectedScheduler,
              }
            };
            if (this.refiner !== "None") {
              genParams.refiner_switch = this.refinerSwitch;
            }
            if (this.forcedSteps >= 1) {
              genParams.advanced_options.overwrite_step = this.forcedSteps;
            }
            if (this.showImageOptions) {
              if (this.imageOptionTab === "uov") {
                if (this.uovImageFile) {
                  genParams.input_image_checkbox = this.showImageOptions;
                  genParams.current_tab = this.imageOptionTab;
                  genParams.uov_method = this.uovSelection;
                  genParams.uov_input_image = {
                    encoded_image: this.uovImageFile,
                  };
                }
              } else if (this.imageOptionTab === "ip") {
                for (const [index, imagePromptUploader] of this.imagePromptImages.entries()) {
                  if (imagePromptUploader) {
                    genParams.input_image_checkbox = this.showImageOptions;
                    genParams.current_tab = this.imageOptionTab;
                    if (typeof genParams.ip_ctrls === "undefined") {
                      genParams.ip_ctrls = [];
                    }
                    ip_control = {
                      ip_image: {
                        encoded_image: imagePromptUploader,
                      },
                      ip_stop: this.imagePrompts[index].params.stopAt,
                      ip_weight: this.imagePrompts[index].params.weight,
                      ip_type: this.imagePrompts[index].params.controlType,
                    };
                    genParams.ip_ctrls.push(ip_control);
                  }
                }
              } else if (this.imageOptionTab === "inpaint") {
                if (this.inpaintImageUploader) {
                  genParams.input_image_checkbox = this.showImageOptions;
                  genParams.current_tab = this.imageOptionTab;
                  const imageData = this.ImageEditor.getCurrentImgData();
                  const inpaintMask = drawAnnotationsOnCanvas(
                    imageData.designState,
                    imageData.imageData.width,
                    imageData.imageData.height).toDataURL("image/png");
                  genParams.inpaint_input_image = {
                    image: {
                      encoded_image: this.inpaintImageUploader,
                    },
                    mask: {
                      encoded_image: inpaintMask,
                    },
                  }
                  if (this.inpaintSelection === "Inpaint or Outpaint (default)") {
                    genParams.outpaint_selections = this.outpaintDirection;
                  } else if (this.inpaintSelection === "Improve Detail (face, hand, eyes, etc.)") {
                    genParams.inpaint_additional_prompt = this.inpaintImprovementPrompt;
                  } else if (this.inpaintSelection === "Modify Content (add objects, change background, etc.)") {
                    genParams.inpaint_additional_prompt = this.inpaintModificationPrompt;
                  }
                }
              }
            }
            return genParams;
          },
          startToGenerate(retry) {
            if (retry > 5) {
              this.generating = false;
              return;
            }
            let socket = null;
            let wsProtocol = "wss";
            if (location.protocol == "http:") {
              wsProtocol = "ws";
            }
            if (this.generating && this.runningTaskId) {
              socket = new WebSocket(`${wsProtocol}://${this.hostname}/api/focus/ws/generate?` + new URLSearchParams({
                task_id: this.runningTaskId,
              }));
            } else {
              this.runningTaskId = randomId();
              socket = new WebSocket(`${wsProtocol}://${this.hostname}/api/focus/ws/generate?` + new URLSearchParams({
                new_task_id: this.runningTaskId,
              }));
              reportSpendCreditsEvent("refocus_generate_button", this.estimateConsume.inference);
            }
            this.generating = true;
            this.runningTaskMessage = "Preparing...";
            socket.onopen = (event) => {
              this.generatingParams = this.packGenerationParameters();
              socket.send(JSON.stringify(this.generatingParams));
              this.runningTaskPreviewImage = '';
              this.runningTaskResultImages = [];
              this.stopLoading = false;
              this.skipLoading = false;
            };
            socket.onmessage = (event) => {
              const status = JSON.parse(event.data);
              this.runningTaskStatus = status.status;
              this.runningTaskProgress = status.progress;
              this.runningTaskMessage = status.message;
              this.runningTaskReturnUrl = status.is_url;
              this.runningTaskQueueLength = status.queue_length;
              this.runningTaskQueuePosiiton = status.queue_position;
              if (status.status === "queueing" || status.status === "preparing") {
                this.waiting = true;
              } else {
                this.waiting = false;
              }
              if (status.status === "preview" && status.images.length > 0) {
                if (status.is_url) {
                  this.runningTaskPreviewImage = status.images[0].image_url;
                } else {
                  this.runningTaskPreviewImage = status.images[0].encoded_image;
                }
              }
              if (status.status === "results" && status.images.length > 0) {
                if (status.is_url) {
                  this.runningTaskPreviewImage = status.images[status.images.length - 1].image_url;
                  this.runningTaskResultImages = status.images.map(item => {
                    return {src: item.image_url, id: item.image_id}});
                } else {
                  this.runningTaskPreviewImage = status.images[status.images.length - 1].encoded_image;
                  this.runningTaskResultImages = status.images.map(item => {
                    return {src: item.encoded_image, id: item.image_id}});
                }
                this.checkNSFW(status.is_nsfw);
              }
              if (status.status === "skipped") {
                this.skipLoading = false;
              }
              if (status.status === "finish") {
                this.stopLoading = false;
                this.generating = false;
                if (status.is_url) {
                  this.runningTaskResultImages = status.images.map(item => {
                    return {src: item.image_url, id: item.image_id}});
                } else {
                  this.runningTaskResultImages = status.images.map(item => {
                    return {src: item.encoded_image, id: item.image_id}});
                }
                this.checkNSFW(status.is_nsfw);
                this.pushHistory();
              }
              if (status.status === "failed") {
                this.stopLoading = false;
                this.generating = false;
                this.pushHistory(status.message);
              }
              if (status.status === "MonitorException.402") {
                this.popup.message =
                      `You have ran out of your credits, please purchase more or upgrade to a \
                      higher plan. Join our ${AFFILIATE_PROGRAM} to earn cash or credits.`;
                this.popup.itemName = "refocus_insufficient_credits";
                this.popup.isOpen = true;
                addPopupGtagEvent(this.popup.URL, this.popup.itemName);
                this.stopLoading = false;
                this.generating = false;
              }
            };
            socket.onerror = (error) => {
              // TODO: show error message
              console.log("WebSocket error:", error);
            };
            socket.onclose = (event) => {
              console.log("WebSocket connection closed:", event.code);
              if (this.generating) {
                if (this.runningTaskId) {
                  setTimeout(() => {
                    this.startToGenerate(retry + 1);
                  }, 3000);
                } else {
                  this.generating = false;
                  this.stopLoading = false;
                }
              }
            };
          },
          skipGeneration() {
            this.skipLoading = true;
            fetch("/api/focus/skip?"+ new URLSearchParams({
                task_id: this.runningTaskId,
              }), {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
            })
            .then(response => {
              if (response.status === 200) {
                return response.json();
              }
              return Promise.reject(response);
            })
            .then((result) => {
              if (result.status === "failed") {
                this.skipLoading = false;
                // TODO: show error message
              }
            })
            .catch((error) => {
              this.skipLoading = false;
              console.error('Post skip error:', error);
            });
          },
          stopGeneration() {
            this.stopLoading = true;
            fetch("/api/focus/stop?"+ new URLSearchParams({
                task_id: this.runningTaskId,
              }), {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
              },
            })
            .then(response => {
              if (response.status === 200) {
                return response.json();
              }
              return Promise.reject(response);
            })
            .then((result) => {
              if (result.status === "failed") {
                this.stopLoading = false;
                // TODO: show error message
              }
            })
            .catch((error) => {
              this.stopLoading = false;
              console.error('Post skip error:', error);
            });
          },
          describeImageLocal() {
            this.describeImageLoading = true;
            fetch("/api/focus/describe/local", {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                mode: this.contentTypeSelection,
                image: {
                  encoded_image: this.describeImageUploader,
                },
              })
            })
            .then(response => {
              if (response.status === 200) {
                return response.json();
              }
              return Promise.reject(response);
            })
            .then((result) => {
              this.prompt = result.prompt;
              this.selectedStyles = result.styles;
              this.describeImageLoading = false;
              if (!result.image_id) {
                // TODO: show error message
              }
            })
            .catch((error) => {
              this.describeImageLoading = false;
              console.error('Post describe error:', error);
            });
          },
          toggleRandom() {
            if (this.isRandom) {
              this.randomSeed = '';
            }
          },
          expandImage(index, images) {
            this.previewIndex = index;
            this.previewImages = images;
            this.previewDialog = true;
          },
          likeOrUnlike(imageId) {
            let like = true;
            if (this.likeButtonColor[imageId]) {
              like = false;
            }
            fetch("/api/focus/like", {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                image_id: imageId,
                like: like,
              })
            })
            .then(response => {
              if (response.status === 200) {
                return response.json();
              }
              return Promise.reject(response);
            })
            .then((result) => {
                if (result.success) {
                  if (result.liked) {
                    this.likeButtonColor[imageId] = 'red-lighten-1';
                  } else {
                    this.likeButtonColor[imageId] = '';
                  }
                }
            })
            .catch((error) => {
              console.error('Post like error:', error);
            });
          },
          favoriteOrUnfavorite(imageId) {
            let favorite = true;
            if (this.favoriteButtonColor[imageId]) {
              favorite = false;
            }
            fetch("/api/focus/favorite", {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                image_id: imageId,
                favorite: favorite,
              })
            })
            .then(response => {
              if (response.status === 200) {
                return response.json();
              }
              return Promise.reject(response);
            })
            .then((result) => {
                if (result.success) {
                  if (result.favorited) {
                    this.favoriteButtonColor[imageId] = 'orange-lighten-1';
                  } else {
                    this.favoriteButtonColor[imageId] = '';
                  }
                }
            })
            .catch((error) => {
              console.error('Post favorite error:', error);
            });
          },
          shareOrUnshare(imageId) {
            let share = true;
            if (this.shareButtonColor[imageId]) {
              share = false;
            }
            fetch("/api/focus/share", {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                image_id: imageId,
                share: share,
              })
            })
            .then(response => {
              if (response.status === 200) {
                return response.json();
              }
              return Promise.reject(response);
            })
            .then((result) => {
                if (result.success) {
                  if (result.shared) {
                    this.shareButtonColor[imageId] = 'blue-lighten-1';
                  } else {
                    this.shareButtonColor[imageId] = '';
                  }
                }
            })
            .catch((error) => {
              console.error('Post share error:', error);
            });
          },
          updateImagePromptDefault(index, styleType) {
            this.imagePrompts[index].params.stopAt = this.imagePromptDefaultValues[styleType].stop;
            this.imagePrompts[index].params.weight = this.imagePromptDefaultValues[styleType].weight;
          },
          updateDefaultOptions(preset, callback=null) {
            this.loadingPreset = true;
            if (this.selectedPreset === preset) {
              this.selectingPreset = false;
              this.loadingPreset = false;
              return;
            }
            fetch("/api/focus/default_options?" + new URLSearchParams({
                preset: preset,
              }), {
              method: 'GET',
            })
            .then(response => {
              if (response.status === 200) {
                return response.json();
              }
              return Promise.reject(response);
            })
            .then((options) => {
              this.defaultOptions = options;
              this.hostname = options.hostname;
              this.aspectRatios = options.aspect_ratios.options;
              this.aspectRatio = options.aspect_ratios.default;
              this.styles = options.styles.options.map(style => {
                return {
                  name: style.style_name,
                  image: style.style_preview,
                }
              });
              this.selectedStyles = options.styles.default_list;
              this.baseModels = options.base_models.options;
              this.baseModel = options.base_models.default;
              this.refiners = options.refiner_models.options;
              this.refiner = options.refiner_models.default;
              this.refinerSwitch = options.refiner_switch;
              this.numLoras = options.loras.length;
              this.uovMethods = options.uovs.options;
              this.uovSelection = options.uovs.default;
              this.ipTypes = options.ip_types.options;
              this.numImagePrompts = options.num_image_prompts;
              this.contentTypeSelection = options.content_types.default;
              this.contentTypes = options.content_types.options;
              this.imagePromptDefaultValues = options.ip_default_options;
              this.selectedLoraModels = [];
              this.selectedLoraWeights = [];
              for (let i = 0; i < this.numLoras; i++) {
                this.selectedLoraModels.push(options.loras[i].lora_name.default);
                this.selectedLoraWeights.push(options.loras[i].lora_weight);
                this.loraModels = options.loras[i].lora_name.options;
              }
              for (let i = 0; i < this.numImagePrompts; i++) {
                this.imagePrompts.push({
                  params: {
                    stopAt: options.ip_default_options[options.ip_types.default].stop,
                    weight: options.ip_default_options[options.ip_types.default].weight,
                    controlType: options.ip_types.default,
                  },
                });
                this.imagePromptImages.push(null);
              }
              this.selectedPreset = preset;
              this.availablePresets = options.presets.options;
              for (const presetName of this.availablePresets) {
                if (!(presetName in this.presetName)) {
                  this.presetName[presetName] = presetName;
                }
                if (!(presetName in this.presetColor)) {
                  this.presetColor[presetName] = "grey-darken-1";
                }
              }
              this.guidanceScale = options.cfg_scale;
              this.imageSharpness = options.sample_sharpness;
              this.selectedSampler = options.sampler.default;
              this.availableSamplers = options.sampler.options;
              this.selectedScheduler = options.scheduler.default;
              this.availableSchedulers = options.scheduler.options;
              if (options.prompt) {
                this.prompt = options.prompt;
              }
              this.negativePrompt = options.negative_prompt;

              this.nonLCMArguments = {};
              this.performanceOptions = options.performances.options;
              this.performance = options.performances.default;
              this.forcedSteps = options.steps;

              this.selectingPreset = false;
              this.loadingPreset = false;
              if (typeof callback === "function") {
                callback(options);
              }
            })
            .catch((error) => {
              console.error('Get default value error:', error);
              this.selectingPreset = false;
              this.loadingPreset = false;
              if (!this.selectedPreset) {
                this.selectedPreset = "default";
              }
            });
          },
          getConsumeText(consume, image_number = null) {
            const inference = consume.inference;
            const discount = consume.discount;

            const real_inference = discount === 0 ? inference
                                                  : Math.ceil(inference * (1 - discount));
            const credit_unit = `credit${real_inference === 1 ? "" :"s"}`;

            let result = discount === 0 ? `Estimated ${real_inference} ${credit_unit}`
                                        : `Estimated <del>${inference}</del> ${real_inference} ${credit_unit}`

            if (image_number) {
                const image_unit = `image${image_number === 1 ? "" :"s"}`;
                result = `${result} for ${image_number} ${image_unit}`;
            }
            return `(${result})`;
          },
          getShapeCeil(width, height) {
            return Math.ceil(Math.sqrt(width * height) / 64.0) * 64.0;
          },
          getTargetResolution() {
            const [width, height] = this.aspectRatio.replace("×", " ").split(" ").slice(0, 2);
            return [Number(width), Number(height)];
          },
          getImageResolution(src) {
            return new Promise((resolve, _) => {
              const img = new Image();
              img.src = src;
              img.onload = () => {
                resolve([img.naturalWidth, img.naturalHeight]);
              };
            });
          },
          getStepsCoefficient() {
            const mapping = {
              "Speed": 2,
              "Quality": 4,
              "Extreme Speed": 1,
              "Turbo": 1,
            }
            return mapping[this.performance];
          },
          async requestCreditsConsumption(args) {
            const body = {
              ...args,
              link_params: {},
              mutipliers: {},
              link_mutipliers: {},
            }

            const response = await fetch(
              "/api/tasks/credits_consumption",
              {
                method: "POST",
                credentials: "include",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ functions: args }),
              }
            )
            if (response.status != 200) {
              return {inference: "-", discount: 0};
            }
            const result = await response.json();
            return {
              inference: result.inference,
              discount: result.discount ? result.discount : 0,
            };
          },
          getUserOrderInformation() {
            fetch(
              '/api/order_info',
              {
                method: 'GET',
                credentials: 'include',
              }
            )
            .then(response => {
              if (response.status === 200) {
                return response.json();
              }
              return Promise.reject(response);
            })
            .then((data) => {
              this.userOrderInformation = data;
            })
            .catch((error) => {
              console.error('getUserOrderInformation error:', error);
            });
          },
          async getImageOptionsConsumeArgs() {
            if (!this.showImageOptions) {
              return;
            }
            if (this.imageOptionTab === "uov") {
              if (!this.uovImageFile) {
                return;
              }
              let [width, height] = await this.getImageResolution(this.uovImageFile);
              if (this.uovSelection.includes("Vary")) {
                const shapeCeil = this.getShapeCeil(width, height);
                if (shapeCeil <= 1024) {
                  width = 1024;
                  height = 1024;
                } else if (shapeCeil >= 2048) {
                  width = 2048;
                  height = 2048;
                }
                return {
                  "fooocus.vary": {
                    params: {
                      width: width,
                      height: height,
                      steps_coefficient: this.getStepsCoefficient(),
                      image_number: this.imageNumber,
                    }
                  }
                }
              }
              if (this.uovSelection.includes("Upscale")) {
                const scale = this.uovSelection.includes("1.5") ? 1.5 : 2.0;
                width *= scale;
                height *= scale;

                let is_fast = this.uovSelection.includes("Fast");

                let shapeCeil = this.getShapeCeil(width, height);
                if (shapeCeil <= 1024) {
                  width = 1024;
                  height = 1024;
                } else if (shapeCeil > 2800) {
                  is_fast = true;
                }
                let steps_coefficient = 0;
                let image_number = 1;
                if (!is_fast) {
                  steps_coefficient = this.getStepsCoefficient();
                  image_number = this.imageNumber;
                }

                return {
                  "fooocus.upscale": {
                    params: {
                      width: width,
                      height: height,
                      steps_coefficient: steps_coefficient,
                      image_number: image_number,
                    }
                  }
                }
              }
              return;
            }
            if (this.imageOptionTab === "inpaint") {
              if (!this.inpaintImageUploader) {
                return;
              }
              let [width, height] = await this.getImageResolution(this.inpaintImageUploader);

              if (this.inpaintSelection === "Inpaint or Outpaint (default)") {
                let scale = 0;
                if (this.outpaintDirection.includes("Top")) {
                  scale += 0.3
                }
                if (this.outpaintDirection.includes("Bottom")) {
                  scale += 0.3
                }
                height += height * scale;

                scale = 0;
                if (this.outpaintDirection.includes("Left")) {
                  scale += 0.3
                }
                if (this.outpaintDirection.includes("Right")) {
                  scale += 0.3
                }
                width += height * scale;
              }
              return {
                "fooocus.inpaint": {
                  params: {
                    width: Math.floor(width),
                    height: Math.floor(height),
                    steps_coefficient: this.getStepsCoefficient(),
                    image_number: this.imageNumber,
                  }
                }
              }
            }
            if (this.imageOptionTab === "ip") {
              let ip_ctrls = 0;
              for (const imagePromptUploader of this.imagePromptImages) {
                if (imagePromptUploader) {
                  ip_ctrls += 1;
                }
              }
              const [width, height] = this.getTargetResolution();
              return {
                "fooocus": {
                  params: {
                    width: width,
                    height: height,
                    steps_coefficient: this.getStepsCoefficient(),
                    ip_ctrls: ip_ctrls,
                    image_number: this.imageNumber,
                  }
                }
              }
            }
            return;
          },
          async updateEstimateConsume(_) {
            let args = await this.getImageOptionsConsumeArgs();
            if (!args) {
              const [width, height] = this.getTargetResolution();
              args = {
                "fooocus": {
                  params: {
                    width: width,
                    height: height,
                    steps_coefficient: this.getStepsCoefficient(),
                    ip_ctrls: 0,
                    image_number: this.imageNumber,
                  }
                }
              }
            }
            if (JSON.stringify(args) === JSON.stringify(this.estimateConsume.args)) {
              return;
            }
            this.estimateConsume.args = args;
            if (this.estimateConsume.timeoutId !== null) {
              clearTimeout(this.estimateConsume.timeoutId);
            }
            this.estimateConsume.timeoutId = setTimeout(
              async () => {
                let request_args = this.estimateConsume.args;
                this.estimateConsume.imageNumber = Object.values(request_args)[0].params.image_number;
                const result = await this.requestCreditsConsumption(request_args);
                this.estimateConsume.inference = result.inference;
                this.estimateConsume.discount = result.discount;
                this.estimateConsume.timeoutId = null;
              },
              1000
            );
          },
          async updateBlipEstimateConsume(_) {
            if (!this.showImageOptions) {
              this.estimateBlipConsume = {inference: "-", discount: 0};
              return;
            }
            if (this.imageOptionTab != "describe") {
              this.estimateBlipConsume = {inference: "-", discount: 0};
              return;
            }
            if (!this.describeImageUploader) {
              this.estimateBlipConsume = {inference: "-", discount: 0};
              return;
            }
            let [width, height] = await this.getImageResolution(this.describeImageUploader);
            args = {
              "fooocus.describe.blip": {
                params: {
                  width: width,
                  height: height,
                }
              }
            }
            const result = await this.requestCreditsConsumption(request_args);
            this.estimateBlipConsume.inference = result.inference;
            this.estimateBlipConsume.discount = result.discount;
          },
          openSubscriptionPage() {
            addUpgradeGtagEvent(this.popup.URL, this.popup.itemName);
          },
          updateLCMOptions() {
            if (this.isLCMMode) {
              this.nonLCMArguments = {
                refiner: this.refiner,
                selectedSampler: this.selectedSampler,
                selectedScheduler: this.selectedScheduler,
                imageSharpness: this.imageSharpness,
                guidanceScale: this.guidanceScale,
              }
              this.refiner = "None";
              this.selectedSampler = "lcm";
              this.selectedScheduler = "lcm";
              this.imageSharpness = 0;
              this.guidanceScale = 1;
            } else if (Object.keys(this.nonLCMArguments).length != 0){
              this.refiner = this.nonLCMArguments.refiner;
              this.selectedSampler = this.nonLCMArguments.selectedSampler;
              this.selectedScheduler = this.nonLCMArguments.selectedScheduler;
              this.imageSharpness = this.nonLCMArguments.imageSharpness;
              this.guidanceScale = this.nonLCMArguments.guidanceScale;
              this.nonLCMArguments = {};
            }
          }
        },
        computed: {
          isLCMMode() {
            return this.performance === "Extreme Speed";
          },
          performance: {
            get() {
              return this._performance;
            },
            set(value) {
              this._performance = value;
              this.updateLCMOptions();
            }
          }
        },
        watch: {
          imageOptionTab(newTab, oldTab) {
            if (oldTab === "inpaint" && newTab !== "inpaint") {
              this.clearEdit();
              this.inpaintImageFiles = [];
            }
          },
          async userOrderInformation(newInfo, oldInfo) {
            if (newInfo) {
              await reportIdentity(
                newInfo.user_id, newInfo.email);
            }
          },
        },
        created() {
          for (let name of [
            "showImageOptions",
            "imageOptionTab",
            "uovImageFile",
            "uovSelection",
            "performance",
            "inpaintImageUploader",
            "inpaintSelection",
            "outpaintDirection",
            "aspectRatio",
            "imageNumber",
          ]) {
            this.$watch(name, this.updateEstimateConsume);
          }
          this.$watch("imagePromptImages", this.updateEstimateConsume, { deep: true });

          for (let name of [
            "showImageOptions",
            "imageOptionTab",
            "describeImageUploader",
          ]) {
            this.$watch(name, this.updateBlipEstimateConsume);
          }
        },
        async mounted() {
          this.updateDefaultOptions(
              "default",
              () => {this.initializeFilerobot(); this.startIntroJS()}
          );
          this.getUserOrderInformation();
        },
      }).use(vuetify).mount('#app');
    </script>
    <script>
      function getIntroJS() {
        return introJs().setOptions({
          tooltipClass: "text-black",
          showProgress: true,
          showBullets: false,
          steps: [
            {
              title: "Refocus Quick Guide",
              element: document.querySelector("#prompt-textarea"),
              intro: "Just simply describe what you would like to see in plain English here.",
            },
            {
              element: document.querySelector("#generate-button"),
              intro: "Click here to generate images.",
            },
            {
              element: document.querySelector("#preset-clip"),
              intro: "Click here to choose a preset for paramters and styles.",
            },
            {
              element: document.querySelector("#img2img-button"),
              intro: "Click here to open the image to image interface.",
            },
            {
              element: document.querySelector("#introjs-button"),
              title: "Enjoy Refocus",
              intro: "Click here to view this guide again. <p> Join our <a href='https://discord.gg/e4UVBNuHyB'>Discord</a> for futher support.</p><br><p>Enjoy!</p>",
            }
          ],
        });
      }
    </script>
  </body>
</html>
